rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    match /users/{userId} {
      // ✅ Cho phép người dùng đọc, tạo, cập nhật, xóa
      // tài liệu của CHÍNH HỌ.
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // 'write' đã bao gồm 'create', 'update', 'delete'
      // 'read' vẫn được giữ nguyên

      // Các quy tắc con này đảm bảo rằng người dùng A
      // không thể đọc hoặc ghi vào dữ liệu của người dùng B.
      
      // Module 1: Tài khoản (Passwords)
      match /accounts/{accountId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Module 1: Authenticator (TOTP/2FA)
      match /totp_accounts/{totpAccountId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Module 2: Năng suất (Ghi chú)
      match /notes/{noteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Module 2: Năng suất (Công việc/Mua sắm)
      match /tasks/{taskId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Module 2: Năng suất (Projects - Thư mục)
      match /projects/{projectId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Module 4: Calendar
      match /calendar_events/{eventId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
